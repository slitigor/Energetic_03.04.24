CREATE DOMAIN pos_double AS double precision CHECK(value >= 0.0);

CREATE TABLE address (
id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
zip varchar(6) NOT NULL UNIQUE,
city varchar(50) NOT NULL,
street varchar(60) NOT NULL
);

CREATE TABLE district (
id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(40) NOT NULL UNIQUE,
description text,
address_id int UNIQUE REFERENCES address(id) ON DELETE CASCADE
);

CREATE TABLE substation(
id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(40) NOT NULL UNIQUE,
ps_schema varchar(20),
district_id int REFERENCES district(id) ON DELETE SET NULL
);

CREATE TABLE switchgear (
id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(10) NOT NULL,
substation_id int REFERENCES substation(id) ON DELETE CASCADE,
UNIQUE(name, substation_id)
);

CREATE TABLE tiresystem(
id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(10) NOT NULL,
switchgear_id int REFERENCES switchgear(id) ON DELETE CASCADE,
nominal pos_double,
UNIQUE(name, switchgear_id)
);

CREATE TABLE e_connection(
id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
title varchar(50) NOT NULL,
dispatch_name varchar(120) NOT NULL UNIQUE,
system_id int REFERENCES tiresystem(id) ON DELETE CASCADE,
UNIQUE(title, system_id)
);

CREATE TABLE category_equipment(
id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(20) NOT NULL UNIQUE
);

CREATE TABLE type_equipment(
id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(50) NOT NULL UNIQUE,
parameters text,
category_id int REFERENCES category_equipment(id) ON DELETE SET NULL
);

CREATE TABLE equipment(
id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
name varchar(20) NOT NULL UNIQUE,
type_id int REFERENCES type_equipment(id) ON DELETE SET NULL,
full_name varchar(60)
);

CREATE TABLE connection_equipment(
connection_id bigint REFERENCES e_connection(id),
equipment_id bigint REFERENCES equipment(id),
PRIMARY KEY(connection_id, equipment_id)
);